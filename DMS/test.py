from ledgerblue.comm import getDongle

dongle = getDongle(True)


pub_key = "120012001212001200121200120012120012001212001200121200120012444479"

secret = "52001200121200120012120012001212001200121200120012120012001244441200120012120012001212001200121200120012120012001212001200124445"

first_block_hash = "9898787867989878786798987878679898787867998987878678987878673333"

nb_block = "01000000"

msg = "8001000000" + pub_key + nb_block + first_block_hash + secret 

publicKey = dongle.exchange(bytes(msg.decode('hex')))


# init check ctx
msg = "8002000000"

publicKey = dongle.exchange(bytes(msg.decode('hex')))


# send first block header and tx_num (varint)
version= "00000020" 
prev_hash = "d8cd962fb66754e1ffaed04f453966a4a19fb7d0cdba21000000000000000000"
merkle_hash = "73a1f218d6315f2b56f02e2074da8b6db3eecd67e14cb3038225863d8964bda2"
time = "b656375b"
bits = "566f3717"
nonce = "acffbee8"

#tx_num="fdbd01"
tx_num="01"

block_header = "8003000000" + version + prev_hash + merkle_hash + time + bits + nonce + tx_num

dongle.exchange(bytes(block_header.decode('hex')))


# send transactions

tx_seg= "01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff2203d9150800049556375b043689150a089254245ba3420000092f426974667572792fffffffff029b3e774b0000000017a914b63fe2af5c45a543d99f29d5626759fd421de3b2870000000000000000266a24aa21a9ed5f7f44fce846134647c3a9d8460de49c50f7dd5beaf5a5a499967db9afdbdea000000000"

tx_leg= "0200000001d40c5407d03e50fdfbdaa1ec97b3ce0cc29d72e7ca360c18221cf903d8b5f51b010000006a47304402203dad2ca83215b123c8c89bfd161b519033eb1c049935e063589f265e05640371022064e64c030368b78ac842d4dd6a2b9959afc2e46ea78f011dcb9db3bbdae23651012103d20c7990a9cccd9d1346d2d1bfa7270030209e73810edd9a33fed28ad1409b50feffffff02400d0300000000001976a9145f8c60ce58c1791c2df2040ef8a086e948f2f22588ac0c7cb132000000001976a914f3f79e50b1556826355864c4daca603e52e50b4888ac1f5a0700"

tx= "0200000001d40c5407d03e50fdfbdaa1ec97b3ce0cc29d72e7ca360c18221cf903d8b5f51b010000006a47304402203dad2ca83215b123c8c89bfd161b519033eb1c049935e063589f265e05640371022064e64c030368b78ac842d4dd6a2b9959afc2e46ea78f011dcb9db3bbdae236510121120012001212001200121200120012120012001212001200121200120012444477feffffff02400d0300000000001976a9145f8c60ce58c1791c2df2040ef8a086e948f2f22588ac0c7cb132000000001976a914f3f79e50b1556826355864c4daca603e52e50b4888ac1f5a0700"

P2_segwit = "00"

while len(tx):

	if len(tx) > 240*2:

		P1_more="00"

		chunk_len = "%02x" % 240

		msg = "8004" + P1_more + P2_segwit + "00" + chunk_len + tx[:240*2]

		dongle.exchange(bytes(msg.decode('hex')))

		tx=tx[240*2:]

		print(tx)

	else:

		P1_more="80"

		chunk_len = "%02x" % (len(tx)/2)

		msg = "8004" + P1_more + P2_segwit + "00" + chunk_len + tx

		dongle.exchange(bytes(msg.decode('hex')))

		tx=""

		print("done with tx")


